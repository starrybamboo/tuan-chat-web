# Copilot 指令 - 团剧共创前端项目

## 项目概述

这是一个基于 React 的团队剧本共创平台前端项目，用于构建多端应用（Web、桌面端、移动端）。项目专注于提供聊天、社区、模组、角色创建等功能，支持 TRPG（桌面角色扮演游戏）场景下的协作创作。

### 核心业务
- **聊天系统**：支持实时聊天、状态显示、私聊、群聊
- **社区功能**：动态发布、关注、点赞、评论
- **模组管理**：模组创建、导入、场景编辑、角色管理
- **角色系统**：角色创建、能力设置、头像管理
- **WebGAL 集成**：跑团 replay 导出功能

## 技术栈

### 核心框架
- **React 19** - 主要前端框架
- **React Router 7** - 路由管理，使用新版 React Router API
- **TypeScript** - 类型系统
- **Vite** - 构建工具

### 状态管理与数据请求
- **TanStack Query (React Query)** - 服务端状态管理和缓存
- **React Hook Form** - 表单状态管理
- **Immer** - 不可变状态更新

### 样式与 UI
- **Tailwind CSS 4** - 样式框架
- **DaisyUI** - UI 组件库
- **Clsx** - 动态类名管理

### 多端开发
- **Electron** - 桌面端应用
- **混合开发** - Android 应用构建

### 可视化与图表
- **@antv/g6** - 图表可视化
- **@xyflow/react** - 流程图编辑
- **React D3 Tree** - 树形图

### 其他重要库
- **WebSocket** - 实时通信
- **Vditor** - Markdown 编辑器
- **React Markdown** - Markdown 渲染
- **Qrcode** - 二维码生成

## 项目结构

```
├── api/                    # API 相关代码
│   ├── hooks/             # React Query hooks
│   ├── models/            # TypeScript 类型定义
│   ├── services/          # API 服务
│   └── core/              # API 核心功能
├── app/                   # 主应用代码
│   ├── components/        # React 组件
│   ├── routes/            # 路由页面
│   ├── utils/             # 工具函数
│   ├── types/             # 类型定义
│   └── webGAL/            # WebGAL 相关
├── electron/              # Electron 配置
├── android/               # Android 配置
└── public/                # 静态资源
```

## 代码规范与最佳实践

### 文件命名规范
- **组件文件**：使用 PascalCase（如 `ChatPage.tsx`）
- **普通文件**：使用 camelCase（如 `userUtils.ts`）
- **路由文件**：使用 camelCase（如 `roleId.tsx`）
- **Hook 文件**：以 `use` 开头 + 功能描述（如 `useWebSocket.tsx`）

### 代码组织规范

#### 导入顺序（已配置 ESLint 自动排序）
```typescript
// 1. 类型导入（带 type 关键字）
import type { Route } from "./+types/root";
import type { ChatStatusType } from "../../../api/wsModels";

// 2. React 相关
import React, { useMemo, useState } from "react";

// 3. 第三方库
import { useQuery } from "@tanstack/react-query";
import { useNavigate, useParams } from "react-router";

// 4. 内部组件和工具
import UserIdToName from "@/components/chat/smallComponents/userIdToName";
import { tuanchat } from "../instance";
```

#### 组件结构
```typescript
// 1. 类型定义
interface ComponentProps {
  roomId: number;
  userId?: number;
}

// 2. 主组件
export default function ComponentName({ roomId, userId }: ComponentProps) {
  // 3. hooks（状态、查询等）
  const navigate = useNavigate();
  const { data } = useQuery(/* ... */);
  
  // 4. 计算值和副作用
  const computedValue = useMemo(() => {
    // 计算逻辑
  }, [dependencies]);
  
  // 5. 事件处理函数
  const handleClick = () => {
    // 处理逻辑
  };
  
  // 6. JSX 返回
  return (
    <div>
      {/* 组件内容 */}
    </div>
  );
}
```

### React Query 使用规范

#### Hook 文件组织
- 按功能模块组织：`chatQueryHooks.tsx`、`moduleQueryHooks.tsx` 等
- 每个文件导出相关的查询和变更 hooks

#### 命名约定
```typescript
// 查询 hooks
export function useGetUserQuery(userId: number) { }
export function useGetUsersQuery(params: UserPageRequest) { }

// 无限查询
export function useGetUserInfiniteQuery(params: FeedPageRequest) { }

// 变更 hooks
export function useCreateUserMutation() { }
export function useUpdateUserMutation() { }
export function useDeleteUserMutation() { }
```

#### 缓存配置
```typescript
export function useGetUserQuery(userId: number) {
  return useQuery({
    queryKey: ['getUser', userId],
    queryFn: () => tuanchat.userController.getUser(userId),
    staleTime: 300000, // 5分钟缓存
    enabled: userId > 0 // 条件查询
  });
}
```

#### 变更后缓存失效
```typescript
export function useUpdateUserMutation() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (userData: UserUpdateRequest) => tuanchat.userController.updateUser(userData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['getUser'] });
      queryClient.invalidateQueries({ queryKey: ['getUserList'] });
    }
  });
}
```

### 路由使用规范

#### React Router 7 新 API
```typescript
// 路由定义 (routes.ts)
export default [
  layout("routes/dashBoard.tsx", [
    index("routes/home.tsx"),
    route("feed/:feedId?", "routes/feed.tsx"),
    ...prefix("role", [
      layout("routes/role.tsx", [
        index("routes/role/entry.tsx"),
        route(":roleId?", "routes/role/roleId.tsx"),
      ]),
    ]),
  ]),
];

// 页面组件中使用
import { useNavigate, useParams, useSearchParams } from "react-router";

export default function PageComponent() {
  const navigate = useNavigate();
  const { roleId } = useParams();
  const [searchParams] = useSearchParams();
}
```

### 样式规范

#### Tailwind CSS 类名使用
```typescript
// 使用 clsx 处理动态类名
import clsx from "clsx";

const buttonClasses = clsx(
  "btn btn-primary", // DaisyUI 基础类
  {
    "btn-loading": isLoading,
    "btn-disabled": disabled,
  }
);

// 响应式设计
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
```

#### 组件样式模式
```typescript
// 容器布局
<div className="h-full bg-base-200 overflow-auto">
  <div className="max-w-4xl mx-auto p-4">
    {/* 内容 */}
  </div>
</div>

// 卡片组件
<div className="card bg-base-100 shadow-xl">
  <div className="card-body">
    {/* 卡片内容 */}
  </div>
</div>
```

## WebSocket 使用规范

### 连接管理
```typescript
import { useWebSocket } from "@/api/useWebSocket";

export default function ChatComponent() {
  const { webSocketUtils } = useWebSocket();
  
  // 使用 webSocketUtils 进行消息发送和状态管理
  const sendMessage = (message: string) => {
    webSocketUtils.sendChatMessage(roomId, message);
  };
}
```

### 状态管理
```typescript
// 聊天状态管理
const { chatStatus } = webSocketUtils;
const roomStatus = chatStatus[roomId] || [];
```

## 组件开发指南

### 通用组件放置
- `app/components/common/` - 通用组件
- `app/components/[feature]/` - 功能模块组件

### 组件类型定义
```typescript
// 明确的 props 类型定义
interface ChatStatusBarProps {
  roomId: number;
  userId: number | undefined | null;
  webSocketUtils: any; // 具体类型待完善
  excludeSelf?: boolean;
}

// 导出组件类型供其他地方使用
export type { ChatStatusBarProps };
```

### 错误处理
```typescript
// 使用 React Router 的错误边界
export function ErrorBoundary() {
  return (
    <div className="error-container">
      <h1>出错了</h1>
      <p>请刷新页面或联系管理员</p>
    </div>
  );
}
```

## API 开发规范

### OpenAPI 集成
- API 模型和服务通过 OpenAPI 自动生成
- 生成的文件在 `api/models/` 和 `api/services/` 目录
- 使用命令 `pnpm openapi` 重新生成

### API 实例配置
```typescript
// api/instance.ts
import { TuanChat } from './TuanChat';

export const tuanchat = new TuanChat({
  BASE: process.env.REACT_APP_API_BASE_URL,
});
```

## 开发工作流

### 开发命令
```bash
# 开发模式
pnpm dev

# 类型检查
pnpm typecheck

# 代码检查和修复
pnpm lint
pnpm lint:fix

# 构建
pnpm build

# Electron 开发
pnpm electron:dev

# Electron 构建
pnpm electron:build
```

### Git 工作流
- 使用 Husky 进行 Git hooks
- 提交前自动运行 lint-staged
- 保持提交信息清晰明确

## 性能优化指南

### React Query 优化
- 合理设置 `staleTime` 避免频繁请求
- 使用 `enabled` 条件控制查询执行
- 适当使用 `useQueries` 进行批量查询

### 组件优化
- 使用 `useMemo` 缓存计算结果
- 使用 `useCallback` 缓存事件处理函数
- 避免在渲染过程中创建新对象

### 路由优化
- 使用路由懒加载减少初始包大小
- 合理使用 `Outlet` 和嵌套路由

## 注意事项

### 重要约定
1. **API Hooks 检查**：添加新的 React Query hook 前，先全局搜索（Ctrl+Shift+F）确保没有重复定义
2. **类型安全**：充分利用 TypeScript，避免使用 `any` 类型
3. **响应式设计**：所有 UI 组件都应该支持响应式设计
4. **国际化准备**：文本内容考虑后续国际化需求
5. **无障碍访问**：遵循基本的无障碍设计原则

### 开发注意点
- 环境变量不要直接使用 `process.env`，已配置 ESLint 规则检查
- 优先使用项目已有的组件和 hooks
- 新功能开发前查看是否有相关的 API hooks 可用
- 保持代码风格与项目一致

### 调试建议
- 使用 React Query Devtools 调试数据流
- 利用 React Developer Tools 调试组件状态
- 通过浏览器开发者工具调试 WebSocket 连接

## 多端开发注意事项

### Electron 开发
- 主进程代码在 `electron/main.cjs`
- 预加载脚本在 `electron/preload.js`
- 构建前确保 WebGAL 相关资源已正确配置

### Android 开发
- 混合开发模式，使用 WebView
- Android 相关配置在 `android/` 目录
- 注意移动端适配和性能优化

---

在开发过程中，请始终遵循以上规范，保持代码质量和项目一致性。如有疑问，请参考项目中的现有代码实现。