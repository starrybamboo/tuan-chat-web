name: TuanChat 自动构建与部署

on:
  push:
    branches: [ "main", "dev" ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-and-deploy:
    name: tuan-chat-web构建与部署
    runs-on: ubuntu-latest
    env:
      DEPLOY_TARGET: ${{ github.ref_name == 'dev' && '/www/wwwroot/tuan-chat-web-test' || '/www/wwwroot/tuan-chat-web' }}
      BUILD_MODE: ${{ github.ref_name == 'dev' && 'test' || 'production' }}
    steps:
      - uses: actions/checkout@v4 # 将目标分支 checkout 到运行环境
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4 # 安装 node
        with:
          node-version: 22.x
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: install
        run: pnpm install --frozen-lockfile

      - name: build
        run: pnpm build --mode $BUILD_MODE

      - name: 部署到服务器
        uses: appleboy/scp-action@v1
        with:
          # 优先使用新版 SERVER_* secrets；保留 SSH_* 兼容旧配置
          host: ${{ secrets.SSH_HOST || '38.14.195.6' }}
          username: ${{ secrets.SERVER_USERNAME || secrets.SSH_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD || secrets.SSH_PASSWORD }}
          source: build/client/**
          target: ${{ env.DEPLOY_TARGET }}
          overwrite: true
          strip_components: 2
#        uses: burnett01/rsync-deployments@7.0.2 # 使用专门的 rsync action
#        with:
#          # rsync 的参数开关
#          # -a: 归档模式，保持文件权限、所有者等信息
#          # -v: 详细模式，显示传输过程
#          # -z: 压缩传输
#          # --delete: 删除目标目录中源目录没有的文件，保持完全同步
#
#          # 源路径和目标路径
#          path: ./build/client/ # ԴĿ¼
#          remote_path: /www/wwwroot/tuan-chat-web-test # 目标目录
#
#          # SSH 连接信息
#          remote_host: 38.14.195.6
#          remote_user: ${{ secrets.SSH_USERNAME }}
#          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}


