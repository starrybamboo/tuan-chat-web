name: Electron 增量更新发布

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: electron-update-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows-installer:
    name: 构建 Windows 安装包
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build NSIS package
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # 避免复用 release/win-unpacked 触发 app.asar 文件占用，使用本次运行专属输出目录。
          $outputDir = "release_ci/windows-${{ github.run_id }}-${{ github.run_attempt }}"

          pnpm -s electron:prepare:resources
          pnpm -s build
          pnpm exec electron-builder build --config electron-builder.json --win nsis --config.directories.output=$outputDir

          "ELECTRON_OUTPUT_DIR=$outputDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Collect update artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          New-Item -ItemType Directory -Path dist-update -Force | Out-Null

          if ([string]::IsNullOrWhiteSpace($env:ELECTRON_OUTPUT_DIR)) {
            throw "ELECTRON_OUTPUT_DIR 未设置"
          }
          $releaseDir = Join-Path (Get-Location) $env:ELECTRON_OUTPUT_DIR
          if (-not (Test-Path $releaseDir)) {
            throw "未找到输出目录：$releaseDir"
          }

          $latest = Join-Path $releaseDir "latest.yml"
          if (-not (Test-Path $latest)) {
            throw "未找到 latest.yml：$latest"
          }

          $setupExe = Get-ChildItem -Path $releaseDir -Filter "*Setup*.exe" |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if ($null -eq $setupExe) {
            throw "未找到 NSIS 安装包（*Setup*.exe）"
          }

          $setupBlockMapPath = "$($setupExe.FullName).blockmap"
          if (-not (Test-Path $setupBlockMapPath)) {
            throw "未找到安装包对应 blockmap：$($setupExe.Name).blockmap"
          }

          Copy-Item $latest -Destination "dist-update/latest.yml" -Force
          Copy-Item $setupExe.FullName -Destination (Join-Path "dist-update" $setupExe.Name) -Force
          Copy-Item $setupBlockMapPath -Destination (Join-Path "dist-update" "$(Split-Path $setupBlockMapPath -Leaf)") -Force

          Write-Host "dist-update files:"
          Get-ChildItem dist-update | Select-Object Name, Length | Format-Table -AutoSize

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: electron-update-files
          path: dist-update/*
          if-no-files-found: error

  publish-update-artifacts:
    name: 上传增量更新文件
    runs-on: ubuntu-latest
    needs: build-windows-installer
    env:
      # 优先使用 UPDATE_*；未配置时回退到 CD 同款 SERVER_*/SSH_*。
      UPDATE_SERVER_HOST: ${{ secrets.UPDATE_SERVER_HOST || '38.14.195.6' }}
      UPDATE_SERVER_PORT: ${{ secrets.UPDATE_SERVER_PORT || '22' }}
      UPDATE_SERVER_USERNAME: ${{ secrets.UPDATE_SERVER_USERNAME || secrets.SERVER_USERNAME || secrets.SSH_USERNAME }}
      UPDATE_SERVER_PASSWORD: ${{ secrets.UPDATE_SERVER_PASSWORD || secrets.SERVER_PASSWORD || secrets.SSH_PASSWORD }}
      # 默认发布到生产站点静态目录下的 updates 子目录，与 electron-builder publish.url 对应。
      UPDATE_SERVER_PATH: ${{ secrets.UPDATE_SERVER_PATH || '/www/wwwroot/tuan-chat-web/updates' }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: electron-update-files
          path: dist-update

      - name: Validate publish secrets
        run: |
          set -euo pipefail

          test -n "${UPDATE_SERVER_HOST}" || { echo "缺少 secret: UPDATE_SERVER_HOST"; exit 1; }
          test -n "${UPDATE_SERVER_USERNAME}" || { echo "缺少 secret: UPDATE_SERVER_USERNAME"; exit 1; }
          test -n "${UPDATE_SERVER_PASSWORD}" || { echo "缺少 secret: UPDATE_SERVER_PASSWORD"; exit 1; }
          test -n "${UPDATE_SERVER_PATH}" || { echo "缺少 secret: UPDATE_SERVER_PATH"; exit 1; }

      - name: Upload update files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ env.UPDATE_SERVER_HOST }}
          username: ${{ env.UPDATE_SERVER_USERNAME }}
          password: ${{ env.UPDATE_SERVER_PASSWORD }}
          port: ${{ env.UPDATE_SERVER_PORT }}
          source: dist-update/*
          target: ${{ env.UPDATE_SERVER_PATH }}
          strip_components: 1
          overwrite: true

      - name: Verify remote files
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.UPDATE_SERVER_HOST }}
          username: ${{ env.UPDATE_SERVER_USERNAME }}
          password: ${{ env.UPDATE_SERVER_PASSWORD }}
          port: ${{ env.UPDATE_SERVER_PORT }}
          script: |
            set -euo pipefail
            TARGET="${{ env.UPDATE_SERVER_PATH }}"

            test -f "${TARGET}/latest.yml"
            find "${TARGET}" -maxdepth 1 -type f -name "*.exe" | grep -q .
            find "${TARGET}" -maxdepth 1 -type f -name "*.exe.blockmap" | grep -q .

            echo "✅ 增量更新文件已发布到 ${TARGET}"
