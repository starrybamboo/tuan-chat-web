name: PR Notification to Feishu

on:
  pull_request:
    branches: [ dev ]
    types: [opened, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Feishu Notification
        uses: actions/github-script@v6
        with:
          script: |
            const crypto = require('crypto');
            const https = require('https');
            
            // é£žä¹¦æœºå™¨äººçš„webhook ID (ä»ŽURLä¸­æå–)
            const webhookId = 'f855c012-5627-4e17-b31d-ab87a25f2192';
            const secret = '${{ secrets.FEISHU_SECRET }}';
            
            // è®¡ç®—ç­¾å - ä¿®æ­£ä¸ºé£žä¹¦APIè¦æ±‚çš„æ ¼å¼
            const timestamp = Math.floor(Date.now() / 1000);
            const stringToSign = `${timestamp}\n${secret}`;
            const sign = crypto.createHmac('sha256', stringToSign).digest('base64');
            
            console.log('Preparing PR notification payload');
            
            // æž„å»ºæ¶ˆæ¯å†…å®¹
            const payload = {
              timestamp: String(timestamp), // è½¬ä¸ºå­—ç¬¦ä¸²
              sign: sign,
              msg_type: "interactive",
              card: {
                config: {
                  wide_screen_mode: true
                },
                header: {
                  title: {
                    tag: "plain_text",
                    content: "ðŸ”” æ”¶åˆ°æ–°çš„PRè¯·æ±‚"
                  },
                  template: "blue"
                },
                elements: [
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**PRæ ‡é¢˜**: ${context.payload.pull_request.title}`
                    }
                  },
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**åˆ›å»ºè€…**: ${context.payload.pull_request.user.login}`
                    }
                  },
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**ç›®æ ‡åˆ†æ”¯**: ${context.payload.pull_request.base.ref}`
                    }
                  },
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**æºåˆ†æ”¯**: ${context.payload.pull_request.head.ref}`
                    }
                  },
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**çŠ¶æ€**: ${context.payload.pull_request.state}`
                    }
                  },
                  {
                    tag: "action",
                    actions: [
                      {
                        tag: "button",
                        text: {
                          tag: "plain_text",
                          content: "æŸ¥çœ‹PRè¯¦æƒ…"
                        },
                        url: context.payload.pull_request.html_url,
                        type: "primary"
                      }
                    ]
                  }
                ]
              }
            };
            
            try {
              console.log('Sending PR notification to Feishu');
              
              // ä¿®æ­£è¯·æ±‚æ–¹å¼ï¼ŒæŒ‰ç…§ç¤ºä¾‹ä»£ç 
              const postData = JSON.stringify(payload);
              
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: 'open.feishu.cn',
                  port: 443,
                  path: `/open-apis/bot/v2/hook/${webhookId}`,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(postData)
                  }
                }, (res) => {
                  let data = '';
                  res.on('data', (chunk) => {
                    data += chunk;
                    process.stdout.write(chunk); // ç›´æŽ¥è¾“å‡ºå“åº”æ•°æ®
                  });
                  
                  res.on('end', () => {
                    console.log(`Feishu API response status: ${res.statusCode}`);
                    console.log(`Feishu API response body: ${data}`);
                    
                    if (res.statusCode !== 200) {
                      return reject(new Error(`Feishu API responded with status: ${res.statusCode}`));
                    }
                    console.log('Feishu notification sent successfully');
                    resolve(data);
                  });
                });
                
                req.on('error', (error) => {
                  console.error('Failed to send Feishu notification:', error.message);
                  reject(error);
                });
                
                req.write(postData);
                req.end();
              });
            } catch (error) {
              console.error('Failed to send Feishu notification:', error.message);
              throw error;
            }
