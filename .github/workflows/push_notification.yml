name: Push Notification to Feishu

on:
  push:
    branches: [ 'main' ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Feishu Notification
        uses: actions/github-script@v6
        with:
          script: |
            const crypto = require('crypto');
            const https = require('https');
            
            // é£žä¹¦æœºå™¨äººçš„webhook ID (ä»ŽURLä¸­æå–)
            const webhookId = '4eb13c2e-cfbd-4e0a-959d-81035324c430';
            const secret = '${{ secrets.FEISHU_SECRET }}';
            
            // è®¡ç®—ç­¾å - ä¿®æ­£ä¸ºé£žä¹¦APIè¦æ±‚çš„æ ¼å¼
            const timestamp = Math.floor(Date.now() / 1000);
            const stringToSign = `${timestamp}\n${secret}`;
            const sign = crypto.createHmac('sha256', stringToSign).digest('base64');
            
            console.log('Preparing Push notification payload');
            
            // æž„å»ºæ¶ˆæ¯å†…å®¹
            const payload = {
              timestamp: String(timestamp), // è½¬ä¸ºå­—ç¬¦ä¸²
              sign: sign,
              msg_type: "interactive",
              card: {
                config: {
                  wide_screen_mode: true
                },
                header: {
                  title: {
                    tag: "plain_text",
                    content: "ðŸš€ Devåˆ†æ”¯æœ‰æ–°çš„Push"
                  },
                  template: "green"
                },
                elements: [
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**æäº¤äºº**: ${context.payload.pusher.name}`
                    }
                  },
                  {
                    tag: "div",
                    text: {
                      tag: "lark_md",
                      content: `**åˆ†æ”¯**: ${context.ref.replace('refs/heads/', '')}`
                    }
                  }
                ]
              }
            };
            
            // èŽ·å–æäº¤ä¿¡æ¯
            const commits = context.payload.commits;
            if (commits && commits.length > 0) {
              let commitMessages = '';
              const maxCommits = Math.min(5, commits.length);
              
              for (let i = 0; i < maxCommits; i++) {
                commitMessages += `â€¢ ${commits[i].message} (${commits[i].id.substring(0, 7)})\n`;
              }
              
              if (commits.length > maxCommits) {
                commitMessages += `...ä»¥åŠå…¶ä»– ${commits.length - maxCommits} ä¸ªæäº¤\n`;
              }
              
              payload.card.elements.push({
                tag: "div",
                text: {
                  tag: "lark_md",
                  content: `**æäº¤ä¿¡æ¯**:\n${commitMessages}`
                }
              });
            }
            
            payload.card.elements.push({
              tag: "action",
              actions: [
                {
                  tag: "button",
                  text: {
                    tag: "plain_text",
                    content: "æŸ¥çœ‹è¯¦æƒ…"
                  },
                  url: `${context.payload.repository.html_url}/commit/${context.payload.after}`,
                  type: "primary"
                }
              ]
            });
            
            try {
              console.log('Sending Push notification to Feishu');
              
              // ä¿®æ­£è¯·æ±‚æ–¹å¼ï¼ŒæŒ‰ç…§ç¤ºä¾‹ä»£ç 
              const postData = JSON.stringify(payload);
              
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: 'open.feishu.cn',
                  port: 443,
                  path: `/open-apis/bot/v2/hook/${webhookId}`,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(postData)
                  }
                }, (res) => {
                  let data = '';
                  res.on('data', (chunk) => {
                    data += chunk;
                    process.stdout.write(chunk); // ç›´æŽ¥è¾“å‡ºå“åº”æ•°æ®
                  });
                  
                  res.on('end', () => {
                    console.log(`Feishu API response status: ${res.statusCode}`);
                    console.log(`Feishu API response body: ${data}`);
                    
                    if (res.statusCode !== 200) {
                      return reject(new Error(`Feishu API responded with status: ${res.statusCode}`));
                    }
                    console.log('Feishu notification sent successfully');
                    resolve(data);
                  });
                });
                
                req.on('error', (error) => {
                  console.error('Failed to send Feishu notification:', error.message);
                  reject(error);
                });
                
                req.write(postData);
                req.end();
              });
            } catch (error) {
              console.error('Failed to send Feishu notification:', error.message);
              throw error;
            }
