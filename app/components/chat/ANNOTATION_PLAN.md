# 消息标注（Annotations）方案（评审稿）

> 目标：提供类似 Discord 的消息标注交互，但**不是反应统计**；标注本身是消息的一部分，只能由作者与 KP 编辑，所有人可见。

## 1. 业务定位
- **用途**：为团剧共创提供“可控封装层”。
- **与 WebGAL 的关系**：
  - Annotation 负责结构化、可控、可编辑的标注（共创层）。
  - WebGAL 保持脚本穿透能力（自由层），允许更高自由度的表达。
  - 二者并存，互不覆盖；Annotation 不替代 WebGAL。

## 2. 核心规则（已确认）
- 公共可见，**仅作者与 KP 可编辑**。
- 只有“存在/不存在”，**不记录来源、不计数**。
- 不去重计数（本身是集合，无重复）。
- 可分类展示（分类规则后续可扩展）。
- 不设上限。
- 可搜索 + 常用（本地即可）。
- 不需要动效/音效播放逻辑（仅标注信息）。

## 3. 数据结构与存储
### 3.1 前端类型
```ts
interface Message {
  // ...
  annotations?: string[];
}
```

### 3.2 后端字段
- `message.annotations`：`jsonb` 数组，默认为空数组 `[]`。
- 仅保存**标注 ID 列表**，具体展示信息来自前端的 catalog。

### 3.3 数据迁移
- 新增字段 `annotations jsonb`，默认空数组。
- 迁移脚本在数据库层执行即可（不影响现有数据）。

## 4. 标注目录（Catalog）
- 结构：系统内置 + 本地自定义。
- 用途：提供标注元信息（展示名、图标/占位、分类等）。
- 分类展示由 catalog 自身的 `category` 字段驱动（未来可扩展）。

## 5. 前端交互设计（Discord 参考）
- **入口**：右键消息 → “添加标注”。
- **展示**：消息下方显示标注条（chips）。
- **添加**：弹出标注选择器（搜索/分类/常用）。
- **编辑权限**：非作者/KP 不显示编辑入口。

## 6. 渲染规则
- **存在标注即可显示**，包括“文字标注”。
- 无标注时不额外占空间。
- 是否单独占行由标注条组件处理。

## 7. WebGAL 与 Annotation 协作建议
- WebGAL 作为“脚本穿透层”保留原字段，不强制迁移。
- Annotation 作为“共创封装层”，只承载受控表达。
- 若未来需要映射，可在渲染层做“Annotation → WebGAL”适配，但数据层不耦合。

## 8. 未来扩展点
- 分类策略（例如：特效/动作/情绪）可直接在 catalog 中实现。
- 后端可增量支持：标注库管理、空间级共享标注等。
- 可加入“推荐/常用”统计（本地或服务端），不影响结构。

---
如需我补充：
- 具体字段名与 API 参数示例
- 目录结构与新增文件清单
- 迁移脚本与回滚策略
