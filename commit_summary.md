# TuanChat 群聊归档功能重构总结

## 概述

本次重构是一个**破坏性变更**，主要实现了群聊归档功能，并将原本基于Stage的版本控制系统迁移到Space上，简化了架构设计。

## 主要业务流程变化

### 1. 核心架构调整：Stage功能迁移到Space

**变更前**：
- 使用独立的Stage暂存区管理模组内容
- 复杂的Branch-Commit-Stage三层架构
- 需要单独创建Stage来管理模组实体

**变更后**：
- 将Stage的功能直接集成到Space中
- 简化为Space-Commit两层架构
- Space创建时自动关联Module和初始Commit

### 2. 模组创建流程简化

**移除的功能**：
- 删除了独立的模组创建接口 `POST /module`
- 移除了复杂的Branch管理逻辑
- 删除了模组导入到群聊的功能

**新的流程**：
- Space创建时自动创建关联的Module
- 每个Space都有自己的版本控制能力
- 通过Commit直接管理Space的归档状态

### 3. 群聊归档功能

**核心特性**：
- **完整归档**：包含Space信息、所有Room、消息历史、角色关系
- **压缩存储**：使用GZIP压缩后存储到MinIO
- **版本管理**：每次提交都会创建完整的归档快照
- **克隆恢复**：支持从任意Commit克隆出完整的群聊环境

**技术实现**：
- 新增 `SpaceArchive` 和 `RoomArchive` 实体
- 集成MinIO进行归档文件存储
- 支持压缩/解压缩处理
- 完整的消息关系重建（回复、线程等）

## 详细改动分析

### 1. 实体层变更

#### 新增实体
- **SpaceArchive**：空间归档信息
- **RoomArchive**：房间归档信息，包含消息列表和角色关系

#### 修改实体
- **Module**：添加 `commitId` 字段，简化创建逻辑
- **StageEntity**：`stageId` 改为 `spaceId`，直接关联空间
- **Commit**：移除 `moduleId`、`branchId`，添加 `extra` 字段存储归档URL
- **Room**：添加JSON类型处理器支持


### 2. 服务层重构

#### StageService 重大变更
- **接口参数调整**：所有 `stageId` 参数改为 `spaceId`
- **权限检查简化**：直接基于Space进行权限验证
- **归档处理**：新增完整的Space归档逻辑
- **克隆功能**：支持从Commit克隆完整群聊环境

#### SpaceService 增强
- **自动Module创建**：Space创建时自动关联Module
- **版本控制集成**：每个Space都具备版本管理能力

#### 移除的服务功能
- **模组导入**：删除从模组导入群聊的复杂逻辑
- **Branch管理**：移除分支相关的所有功能
- **独立模组创建**：模组现在只能通过Space间接创建

### 3. 控制器层调整

#### StageController
- 移除独立的Stage查询接口
- 参数统一调整为 `spaceId`
- 新增克隆接口 `POST /clone`

#### SpaceModuleController
- 大幅简化，移除导入/导出相关接口

#### ModuleController
- 移除独立的模组创建接口

### 4. 数据访问层优化

#### DAO层调整
- **StageEntityDao**：方法名从 `stageId` 调整为 `spaceId`
- **删除SpaceRoleDao**：相关功能整合到其他DAO中

#### Mapper层变更
- 更新Commit查询逻辑，直接从Module获取commitId
- 删除SpaceRoleMapper

### 5. 工具类增强

## 业务价值

### 1. 架构简化
- **降低复杂度**：从三层架构简化为两层
- **减少概念**：用户不再需要理解Stage和Branch概念
- **统一管理**：Space成为唯一的内容管理单元

### 2. 功能增强
- **完整归档**：支持群聊的完整状态保存
- **历史追溯**：通过Commit可以查看任意时间点的群聊状态
- **环境克隆**：支持快速复制群聊环境用于测试或备份

### 3. 用户体验提升
- **操作简化**：减少了模组创建和导入的复杂步骤
- **自动化**：Space创建自动处理版本控制初始化
- **透明化**：归档过程对用户透明，自动完成

## 技术亮点


## 影响范围

### 1. 破坏性变更
- 所有Stage相关的API接口参数调整
- 前端需要适配新的接口规范
- 数据库schema需要相应调整

### 2. 功能移除
- 独立的模组创建功能
- 模组导入到群聊功能
- Branch分支管理功能

### 3. 新增功能
- 群聊归档能力
- 从归档克隆群聊
- 自动版本管理

## 总结

这次重构是一个重要的架构优化，通过将Stage功能迁移到Space上，大大简化了系统的复杂度，同时新增的群聊归档功能为用户提供了强大的数据管理能力。虽然是破坏性变更，但长期来看将显著提升系统的可维护性和用户体验。
