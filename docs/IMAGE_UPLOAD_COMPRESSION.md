# 图片上传压缩说明

## 背景
前端在上传图片前会进行一次客户端侧压缩，以降低带宽与存储成本，并尽量保证清晰度与上传速度的平衡。

本说明文档用于记录当前“图片压缩 + 上传”链路的核心行为与可调参数，便于排查问题与后续迭代。

## 代码入口
- 上传入口：`app/utils/UploadUtils.ts` 中的 `uploadImg(file, scene, quality?, maxSize?)`
- 压缩实现：`app/utils/imgCompressUtils.ts` 中的 `compressImage(file, quality?, maxSize?)`

## 当前压缩行为（概要）
- 默认参数：`quality = 0.7`，`maxSize = 2560`（限制最长边）。
- GIF：不压缩（保持原文件），直接上传。
- 非 GIF：优先压缩为 WebP（`image/webp`），并启用 Web Worker 以减少主线程阻塞。

## 依赖
- 使用 `browser-image-compression` 实现压缩（支持 Web Worker、质量参数、最大边限制等）。

## 兜底策略：压缩后变大处理
部分图片（尤其是已经高度优化的 JPEG/PNG）在转码到 WebP 后可能出现“体积反而变大”。

当前策略：
1. 以传入的 `quality` 为起点进行压缩。
2. 若压缩结果体积 **不小于** 原图，会自动用更低的质量参数重试若干次（取最小体积结果）。
3. 若多次重试后仍无法比原图更小，则 **回退为原图上传**。

该策略的目标是：
- 尽量压缩；
- 但不强制“为了 WebP 而变大”，避免浪费带宽与存储。

## 上传文件扩展名规则
上传前会根据 **最终要上传的文件的 MIME Type** 来决定文件名扩展名（例如 `.webp` / `.jpg`）。

这点与“回退原图”策略配套：
- 当压缩成功并输出 WebP 时，扩展名为 `.webp`；
- 当回退原图（例如 JPEG）时，扩展名会随之变为 `.jpg`，避免出现“内容是 JPEG 但文件名是 .webp”的不一致。

## 可调参数建议
- `quality`（默认 0.7）
  - 更清晰：提高到 0.8~0.85（体积会变大）。
  - 更小：降低到 0.6~0.65（画质会更损失，尤其是文字/线条）。
- `maxSize`（默认 2560）
  - 移动端/弱网：可考虑 1440 或 1920。
  - 需要更高清：可考虑 3200，但注意耗时与内存。

## 注意事项
- 客户端压缩受浏览器实现与设备性能影响，超大图在低端设备上可能仍有明显耗时。
- GIF 若需要“动图压缩/转码”，通常需要更专业的链路（当前未做）。
