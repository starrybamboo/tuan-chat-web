# 变更提案: WebGAL 空间变量系统（聊天指令驱动）

## 需求背景

当前聊天室已支持 WebGAL 联动（`MessageType.WEBGAL_COMMAND` 写入脚本、`-when` 条件分支等），但缺少可在聊天过程中可控、可持久化的变量系统，导致分支/条件跳转需要依赖外部脚本维护，难以在“跑团/共创”聊天过程中逐步推进状态。

本变更希望引入 WebGAL Script 的变量语法（`setVar:*`、`-when`、`{}` 插值等）的“聊天侧驱动”能力：
- 变量变更通过聊天指令触发，并落为一条消息（任何人都可发送）
- 变量按“空间级”持久化（跨房间共享，可用于空间内工作流/条件跳转）
- 不替换现有先攻表，仅新增变量能力

## 变更内容

1. 新增一种“变量变更”消息类型，用于承载结构化的变量更新（而非任意 WebGAL 脚本）。
2. 新增聊天侧指令（建议 `/var ...`），将指令转换为“变量变更”消息并发送。
3. 将变量变更同步到 `space.extra`，作为空间级持久化存储（last-write-wins）。
4. WebGAL 实时渲染侧识别该消息类型，并写入等价的 WebGAL Script（`setVar:... -global;`）。
5. Chat UI/导出对该消息类型提供可读展示（例如“[变量] a = 1”）。

## 影响范围

- **模块**:
  - Chat 输入/发送（`RoomWindow`）
  - WebSocket 消息类型（`api/wsModels.ts`）
  - WebGAL 实时渲染（`app/webGAL/realtimeRenderer.ts`）
  - 聊天导出（`app/utils/exportChatMessages.ts`）
  - Chat 消息展示（`chatBubble` 等）
- **数据**:
  - `space.extra` 新增 `webgalVars` 字段（JSON 对象）

## 核心场景

### 需求 1：空间级变量（持久化）

**模块:** Chat / Space

#### 场景：通过聊天指令设置变量
- 用户在任意房间输入 `/var set a=1`（或等价语法）
- 客户端发送一条“变量变更消息”，并将 `a=1` 合并写入 `space.extra.webgalVars`
- 其他客户端收到消息后可见“变量已更新”的展示

#### 场景：跨房间共享变量
- 在房间 A 设置的变量 `a`，在房间 B 中通过 WebGAL 条件（`-when=a==1`）生效

### 需求 2：变量变更消息类型

**模块:** WebSocket / Chat UI

#### 场景：消息可读展示与可导出
- 聊天流中显示为结构化信息（而非普通文本/脚本）
- 导出聊天记录时能输出可读文本（例如 `[变量] a = 1`）

### 需求 3：WebGAL 实时渲染联动

**模块:** WebGAL RealtimeRenderer

#### 场景：变量变更写入脚本并影响后续渲染
- 实时渲染开启时，收到变量变更消息后，写入 `setVar:a=1 -global;`
- 后续消息/分支脚本可使用 `-when=a==1`、`{a}` 插值等语法

## 风险评估

- **并发写入冲突:** 多人同时更新同一变量时以 last-write-wins 处理；必要时可在后续迭代引入版本号/消息序号防抖。
- **权限与滥用:** 变量变更消息任何人可发；同时系统已存在“任意 WebGAL 脚本”发送能力（`%` -> `WEBGAL_COMMAND`），本功能的风险边界可控且更结构化。
- **兼容性:** `space.extra` 需保持向后兼容；应避免覆盖既有字段（例如 `dicerData`）。

