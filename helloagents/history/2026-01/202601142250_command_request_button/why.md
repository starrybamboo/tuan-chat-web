# 变更提案: 跑团检定请求按钮消息

## 需求背景
跑团聊天中，KP 经常需要玩家进行某个检定/掷骰。当前流程通常是玩家手动复制 KP 的指令并发送，容易漏发、打错或影响节奏。

本提案增加一种“检定请求按钮消息”：KP 发送请求后不执行；其他成员点击“一键发送”即可按自己的角色身份发送并执行对应指令，且执行消息落在原消息所在 thread 中，便于对齐上下文。

## 变更内容
1. 支持 KP 通过输入包含 `@All` 的跑团指令，发送“检定请求按钮消息”（不触发执行）。
2. 渲染侧将该消息展示为可点击按钮，并在满足权限/角色条件时允许“一键发送”。
3. 点击执行时以点击者当前选择角色发送指令，并确保骰娘回复链路与 threadId/回复引用一致。

## 影响范围
- **模块:** app（chat 组件、dicer 命令执行器）
- **文件:**
  - `app/components/chat/room/roomWindow.tsx`
  - `app/components/chat/chatFrame.tsx`
  - `app/components/chat/message/chatBubble.tsx`
  - `app/components/common/dicer/cmdPre.tsx`
  - `app/components/common/dicer/cmdType.d.ts`
- **API:** 无（复用现有消息发送接口；仅扩展 extra 透传）
- **数据:** 无（仅新增 message.extra 中的 commandRequest 字段）

## 核心场景

### 需求: KP 发起检定请求（不执行）
**模块:** chat
KP 发送带 `@All` 的跑团指令时，系统不执行指令，而是发送一个“检定请求按钮消息”。

#### 场景: KP 在 thread 中请求全员检定
KP 在 thread 输入 `.rc 侦查 @All`（或 `.r3d6*5 @All`），发送后聊天流出现“检定请求”按钮消息，且该消息归属于当前 thread。
- 预期结果: 不触发骰娘执行；消息渲染为按钮并展示要执行的指令。

### 需求: 玩家点击一键发送（按自己身份执行）
**模块:** chat + dicer
玩家点击“检定请求”按钮后，系统以玩家当前选择角色发送并执行相同指令，结果消息（含骰娘回复）落在原 thread 中。

#### 场景: 观战成员点击按钮被禁止
观战成员点击按钮时，系统提示不可发送消息。
- 预期结果: 不发送任何消息，不触发指令执行。

## 风险评估
- **风险:** 通过 `@All` 触发的“请求”语义可能与普通文本中的 `@All` 混淆。
- **缓解:** 仅当消息中能提取到合法指令文本时才生成请求；请求消息单独渲染为带标识的按钮，且执行时使用结构化字段 `extra.commandRequest.command`，避免二次触发请求。
