# 变更提案: NovelAI 自然语言生图（简单形态）

## 需求背景

当前 `/ai-image` 页面提供的是“复杂形态”（对齐 NovelAI Image 的参数面板），用户需要自行编写适合 NovelAI 的 tags/prompt 才能稳定出图。希望增加“简单形态”：用户只需输入自然语言描述，系统自动将其转换为适合 NovelAI 的 tag 集合，并继续走现有 NovelAI 生图链路。

## 产品分析

### 目标用户与场景

- **用户群体:** 不熟悉 NovelAI tag 体系的普通用户；只想快速出图的跑团/共创用户
- **使用场景:** 快速把“自然语言脑洞”转成可出图的 prompt；在复杂参数面板中进行二次微调
- **核心痛点:** 需要记忆 tag、权重语法与常见负面词；试错成本高

### 价值主张与成功指标

- **价值主张:** 用自然语言一键出图，同时保留复杂面板的可控性
- **成功指标:**
  - 简单形态可以稳定生成 prompt/negative prompt 并成功出图
  - 用户可一键把生成的 tags 回填到复杂面板继续调参
  - 转换失败时有明确错误提示且不影响原复杂形态使用

### 人文关怀

- 默认输出不包含敏感/侵害/未成年人等内容的引导；转换提示词要求模型避免生成违法或不当内容标签

## 变更内容

1. 在 `AI 生图（NovelAI）` 页面新增“简单形态”入口与交互：自然语言 → tags → 出图
2. 新增 NL→tags 的转换工具：通过现有后端 LLM 接口（`/ai/writing/flash`）完成结构化输出与解析
3. 增强可用性：展示转换结果（prompt/negative prompt）、允许一键回填到复杂面板

## 影响范围

- **模块:** app（路由页面与 UI）、api（复用现有 tuanchat 客户端实例）
- **文件:** `app/routes/aiImage.tsx`、`app/utils/novelaiNl2Tags.ts`、知识库文档
- **API:** 复用既有 `/ai/writing/flash`（不新增后端接口）
- **数据:** 无

## 核心场景

### 需求: 简单形态自然语言生图
**模块:** app
用户输入自然语言描述（可选补充“不希望出现的内容”），点击“一键出图”，系统自动转换为 NovelAI tags 并生成图片。

#### 场景: 自然语言一键出图
用户已配置 NovelAI token（或在 Electron 环境下可走 IPC）。
- 自动将自然语言转换为 `prompt`/`negativePrompt`
- 调用与复杂形态一致的 NovelAI 生图流程（txt2img/img2img 仍由复杂面板控制）
- 生成成功后写入历史记录，并可回看

#### 场景: 转换结果回填复杂面板
用户希望进一步微调 tags/参数。
- 可将转换后的 `prompt`/`negativePrompt` 回填到复杂面板的输入框

## 风险评估

- **风险:** LLM 输出不稳定导致解析失败
  - **缓解:** 强约束 JSON 输出 + 容错解析；失败时提示并允许手动编辑
- **风险:** 依赖后端 `/ai/writing/flash` 可用性
  - **缓解:** 转换失败不阻断复杂形态；UI 中明确提示后端不可用

