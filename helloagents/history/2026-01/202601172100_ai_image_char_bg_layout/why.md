# 变更提案: AI 生图（角色/背景 Prompt + 双模式三栏对齐）

## 需求背景
- 现状：AI 生图页面已支持“普通模式/专业模式”，但专业模式仍是单一 Prompt/Negative 文本框，未对齐 NovelAI 官网的“背景/角色”分区；普通模式与专业模式的预览/历史布局不一致，复用度低。
- 问题：缺少角色/背景分区会削弱 v4/v4.5 的结构化 prompt 表达能力；布局不一致导致用户切换模式时认知负担大。

## 变更内容
1. 专业模式增加“背景/角色”分区编辑，并映射到 `v4_prompt` / `v4_negative_prompt` 的 `char_captions`。
2. 普通/专业两模式统一为三栏布局：左侧 Prompt/参数，中间图片预览，右侧出图历史；中间/右侧尽量复用同一套 UI。
3. 历史记录支持回填角色/背景结构（向后兼容旧记录）。

## 影响范围
- **模块:** `app/routes/aiImage.tsx`（主页面）、`electron/main.js`（Electron 直连生成）、`app/utils/aiImageHistoryDb.ts`（历史结构扩展）
- **文件:** 见上
- **API:** 不新增后端 API；仅调整 NAI v4/v4.5 请求参数映射
- **数据:** IndexedDB 历史记录增加可选字段（不变更 objectStore 结构，向后兼容）

## 核心场景

### 需求: 专业模式角色/背景分区
**模块:** AI 生图页面
用户希望像 NovelAI 官网一样，把 prompt 拆分为“背景（base）”与“角色（char）”，并影响实际出图。

#### 场景: 多角色出图
用户在背景里写场景 tags，在角色列表里写每个角色 tags（可调整顺序/坐标开关），点击生成后，服务端按 `char_captions` 渲染角色信息。

### 需求: 两模式三栏对齐
**模块:** AI 生图页面
普通模式与专业模式的预览/历史位置应一致，便于切换与复用。

#### 场景: 普通模式一键生成后继续编辑
用户在普通模式输入自然语言，点击生成（自动 NL→tags→出图），生成后可继续编辑 tags，再次生成；预览/历史区域位置与专业模式一致。

## 风险评估
- **风险:** v4/v4.5 的结构化字段命名不一致会导致上游 500
- **缓解:** 以 `koishijs/novelai-bot` 的类型定义为参考（`char_caption` + `centers[{x,y}]`，`use_order/use_coords`），保持最小必要字段，逐步扩展；失败时保留可回退到仅 `base_caption` 的路径。

