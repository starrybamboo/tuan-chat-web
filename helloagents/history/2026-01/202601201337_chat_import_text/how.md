# 技术设计: 聊天室文本导入（txt → 多条消息）

## 技术方案

### 核心技术
- React 组件（弹窗 + 表单）
- 纯前端解析工具函数（正则解析每行）
- 复用现有消息发送流程（`ChatMessageRequest` + `sendMessageWithInsert`）

### 实现要点
- 新增解析工具 `parseImportedChatText`：将文本拆分为行，按 `^\s*\[(speaker)\]\s*[:：]\s*(content)\s*$` 提取说话人与内容；空行忽略，无法解析或缺失字段的行计入无效行列表。
- 新增导入弹窗 `ImportChatMessagesWindow`：
  - 支持选择 `.txt` 文件或直接粘贴文本
  - 自动生成“说话人 → 角色”映射：若房间角色名唯一命中则自动选择，否则要求用户手动选择
  - KP 额外提供“旁白（roleId=-1）”选项
  - 发送过程中展示进度
- `RoomWindow` 增加导入入口状态（URL search param 控制弹窗开关），并提供 `handleImportChatText`：
  - 导入期间清理 reply/insert UI 状态，避免“插入模式”影响导入顺序
  - 按当前输入目标决定是否发送到 thread
  - 复用用户对角色的本地“自定义角色名”配置（若存在则写入 `webgal.customRoleName`）

## 安全与性能

- **安全:** 不持久化导入文本；仅在前端内存中处理；不涉及敏感信息写入或权限提升。
- **性能:** 解析为线性扫描；大批量导入时加入轻量节流，降低短时间发送压力。

## 测试与部署

- **测试:** 新增单元测试覆盖解析函数（中文/英文冒号、空行、无效行统计）。
- **部署:** 纯前端改动，无需额外部署步骤。

