# 变更提案: 文档卡片消息（Blocksuite Doc Card）

## 需求背景
当前聊天仅支持文本/ͼƬ/音频/转发等消息类型，无法把“空间内的 Blocksuite 文档”以卡片形式发送到聊天室；成员也无法把侧边栏/文档树中的文档拖入聊天室快速分享。

本变更希望支持：
1. 发送一条“文档卡片消息”（引用 docId），卡片展示标题、封面与内容预览（只读）。
2. 支持从侧边栏文档树拖拽文档到消息列表或输入框区域，直接发送文档卡片消息。
3. 点击卡片后以弹窗方式打开 Blocksuite 只读预览。
4. 仅允许在同一 space 内发送/预览，不支持跨 space 分享。

## 产品分析

### 目标用户与场景
- **用户群体:** 空间内的 KP / 成员（需要分享空间文档的协作型用户）
- **使用场景:**
  - KP 在跑团过程中把“空间资料/文档”快速发到频道，让成员点击查看
  - 成员从文档树拖拽一份文档引用到聊天，作为讨论上下文
- **核心痛点:**
  - 文档分享缺少结构化承载（只能发链接/口头描述）
  - 操作路径长（需要复制/粘贴/切换页面），难以在讨论过程中快速引用

### 价值主张与成功指标
- **价值主张:** 用“可预览的卡片引用”降低分享成本，提高讨论效率
- **成功指标:**
  - 侧边栏拖拽到聊天室后可稳定发送文档卡片（成功率高、反馈明确）
  - 点击卡片可在弹窗中只读预览，且预览内容与远端一致（不要求离线）
  - 卡片在消息流中占用空间合理、加载性能可接受（懒加载/缓存）

### 人文关怀
- 只读预览避免误编辑导致的协作冲突
- 限制同一 space，避免误分享造成的权限/隐私问题

## 变更内容
1. 新增“文档卡片消息”类型与渲染组件（标题/封面/内容预览）。
2. 新增点击卡片的弹窗只读 Blocksuite 预览。
3. 新增 DnD 协议：从文档树拖拽到输入框/消息列表即可发送文档卡片。

## 影响范围
- **模块:**
  - 聊天消息渲染（chat bubble）
  - 聊天输入与消息列表 DnD（composer / chat frame）
  - Blocksuite 文档只读预览（复用现有 BlocksuiteDescriptionEditor）
- **文件:**
  - `app/components/chat/message/*`
  - `app/components/chat/room/*`
  - `app/components/chat/utils/*`
  - `app/types/voiceRenderTypes.ts`
- **API:**
  - 不新增后端 API（复用 `/blocksuite/doc` 的 snapshot 读取能力）
- **数据:**
  - 新增一种 messageType（前端约定），消息 extra 增加 doc 引用信息

## 核心场景

### 需求: 发送文档卡片消息
**模块:** 聊天消息发送/渲染
在空间内，用户可以发送一条引用 Blocksuite 文档的卡片消息。

#### 场景: 点击发送按钮发送文档卡片
用户在 UI 入口选择一个空间文档，发送后消息流中出现卡片。
- 卡片展示标题、封面、内容预览（只读）
- 点击卡片打开弹窗只读预览

### 需求: 文档拖拽发送
**模块:** 侧边栏文档树 / DnD
用户可以把文档从文档树拖拽到聊天输入框或消息列表区域，直接发送卡片。

#### 场景: 从文档树拖拽到输入框区域
- 拖入后立即发送文档卡片消息
- 不改变文档树中的文档排序/结构（拖拽语义为“复制引用”，不是“移动节点”）

#### 场景: 从文档树拖拽到消息列表区域
- 同样立即发送文档卡片消息
- 可在拖拽过程中提供明确的可投放反馈

### 需求: ͬһ space 限制
**模块:** 发送校验/渲染校验
不允许跨 space 分享，避免权限与隐私风险。

#### 场景: 在非同一 space 场景触发拖拽/发送
- 阻止发送，并提示“仅支持在同一空间分享文档”

## 风险评估
- **风险:** Blocksuite 预览能力引入额外加载与网络请求，可能造成消息列表卡顿
  - **缓解:** 卡片预览信息懒加载；对每条消息做缓存与并发去重；滚动列表中避免创建 editor 实例，仅在弹窗里渲染 Blocksuite
- **风险:** “独立文档（doc:<key>）”为本地存储，其他成员无法读取
  - **缓解:** 文档卡片仅支持可远端读取的 Blocksuite docId（如 `space/room/clue/udoc:*:description` 体系），不支持本地独立文档直接分享；必要时提供降级提示

